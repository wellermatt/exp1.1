<!DOCTYPE html>
<!-- saved from url=(0014)about:internet -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>ets_functions.R</title>

<style type="text/css">
body, td {
   font-family: sans-serif;
   background-color: white;
   font-size: 12px;
   margin: 8px;
}

tt, code, pre {
   font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace;
}

h1 { 
   font-size:2.2em; 
}

h2 { 
   font-size:1.8em; 
}

h3 { 
   font-size:1.4em; 
}

h4 { 
   font-size:1.0em; 
}

h5 { 
   font-size:0.9em; 
}

h6 { 
   font-size:0.8em; 
}

a:visited {
   color: rgb(50%, 0%, 50%);
}

pre {	
   margin-top: 0;
   max-width: 95%;
   border: 1px solid #ccc;
   white-space: pre-wrap;
}

pre code {
   display: block; padding: 0.5em;
}

code.r, code.cpp {
   background-color: #F8F8F8;
}

table, td, th {
  border: none;
}

blockquote {
   color:#666666;
   margin:0;
   padding-left: 1em;
   border-left: 0.5em #EEE solid;
}

hr {
   height: 0px;
   border-bottom: none;
   border-top-width: thin;
   border-top-style: dotted;
   border-top-color: #999999;
}

@media print {
   * { 
      background: transparent !important; 
      color: black !important; 
      filter:none !important; 
      -ms-filter: none !important; 
   }

   body { 
      font-size:12pt; 
      max-width:100%; 
   }
       
   a, a:visited { 
      text-decoration: underline; 
   }

   hr { 
      visibility: hidden;
      page-break-before: always;
   }

   pre, blockquote { 
      padding-right: 1em; 
      page-break-inside: avoid; 
   }

   tr, img { 
      page-break-inside: avoid; 
   }

   img { 
      max-width: 100% !important; 
   }

   @page :left { 
      margin: 15mm 20mm 15mm 10mm; 
   }
     
   @page :right { 
      margin: 15mm 10mm 15mm 20mm; 
   }

   p, h2, h3 { 
      orphans: 3; widows: 3; 
   }

   h2, h3 { 
      page-break-after: avoid; 
   }
}

</style>

<!-- Styles for R syntax highlighter -->
<style type="text/css">
   pre .operator,
   pre .paren {
     color: rgb(104, 118, 135)
   }

   pre .literal {
     color: rgb(88, 72, 246)
   }

   pre .number {
     color: rgb(0, 0, 205);
   }

   pre .comment {
     color: rgb(76, 136, 107);
   }

   pre .keyword {
     color: rgb(0, 0, 255);
   }

   pre .identifier {
     color: rgb(0, 0, 0);
   }

   pre .string {
     color: rgb(3, 106, 7);
   }
</style>

<!-- R syntax highlighter -->
<script type="text/javascript">
var hljs=new function(){function m(p){return p.replace(/&/gm,"&amp;").replace(/</gm,"&lt;")}function f(r,q,p){return RegExp(q,"m"+(r.cI?"i":"")+(p?"g":""))}function b(r){for(var p=0;p<r.childNodes.length;p++){var q=r.childNodes[p];if(q.nodeName=="CODE"){return q}if(!(q.nodeType==3&&q.nodeValue.match(/\s+/))){break}}}function h(t,s){var p="";for(var r=0;r<t.childNodes.length;r++){if(t.childNodes[r].nodeType==3){var q=t.childNodes[r].nodeValue;if(s){q=q.replace(/\n/g,"")}p+=q}else{if(t.childNodes[r].nodeName=="BR"){p+="\n"}else{p+=h(t.childNodes[r])}}}if(/MSIE [678]/.test(navigator.userAgent)){p=p.replace(/\r/g,"\n")}return p}function a(s){var r=s.className.split(/\s+/);r=r.concat(s.parentNode.className.split(/\s+/));for(var q=0;q<r.length;q++){var p=r[q].replace(/^language-/,"");if(e[p]){return p}}}function c(q){var p=[];(function(s,t){for(var r=0;r<s.childNodes.length;r++){if(s.childNodes[r].nodeType==3){t+=s.childNodes[r].nodeValue.length}else{if(s.childNodes[r].nodeName=="BR"){t+=1}else{if(s.childNodes[r].nodeType==1){p.push({event:"start",offset:t,node:s.childNodes[r]});t=arguments.callee(s.childNodes[r],t);p.push({event:"stop",offset:t,node:s.childNodes[r]})}}}}return t})(q,0);return p}function k(y,w,x){var q=0;var z="";var s=[];function u(){if(y.length&&w.length){if(y[0].offset!=w[0].offset){return(y[0].offset<w[0].offset)?y:w}else{return w[0].event=="start"?y:w}}else{return y.length?y:w}}function t(D){var A="<"+D.nodeName.toLowerCase();for(var B=0;B<D.attributes.length;B++){var C=D.attributes[B];A+=" "+C.nodeName.toLowerCase();if(C.value!==undefined&&C.value!==false&&C.value!==null){A+='="'+m(C.value)+'"'}}return A+">"}while(y.length||w.length){var v=u().splice(0,1)[0];z+=m(x.substr(q,v.offset-q));q=v.offset;if(v.event=="start"){z+=t(v.node);s.push(v.node)}else{if(v.event=="stop"){var p,r=s.length;do{r--;p=s[r];z+=("</"+p.nodeName.toLowerCase()+">")}while(p!=v.node);s.splice(r,1);while(r<s.length){z+=t(s[r]);r++}}}}return z+m(x.substr(q))}function j(){function q(x,y,v){if(x.compiled){return}var u;var s=[];if(x.k){x.lR=f(y,x.l||hljs.IR,true);for(var w in x.k){if(!x.k.hasOwnProperty(w)){continue}if(x.k[w] instanceof Object){u=x.k[w]}else{u=x.k;w="keyword"}for(var r in u){if(!u.hasOwnProperty(r)){continue}x.k[r]=[w,u[r]];s.push(r)}}}if(!v){if(x.bWK){x.b="\\b("+s.join("|")+")\\s"}x.bR=f(y,x.b?x.b:"\\B|\\b");if(!x.e&&!x.eW){x.e="\\B|\\b"}if(x.e){x.eR=f(y,x.e)}}if(x.i){x.iR=f(y,x.i)}if(x.r===undefined){x.r=1}if(!x.c){x.c=[]}x.compiled=true;for(var t=0;t<x.c.length;t++){if(x.c[t]=="self"){x.c[t]=x}q(x.c[t],y,false)}if(x.starts){q(x.starts,y,false)}}for(var p in e){if(!e.hasOwnProperty(p)){continue}q(e[p].dM,e[p],true)}}function d(B,C){if(!j.called){j();j.called=true}function q(r,M){for(var L=0;L<M.c.length;L++){if((M.c[L].bR.exec(r)||[null])[0]==r){return M.c[L]}}}function v(L,r){if(D[L].e&&D[L].eR.test(r)){return 1}if(D[L].eW){var M=v(L-1,r);return M?M+1:0}return 0}function w(r,L){return L.i&&L.iR.test(r)}function K(N,O){var M=[];for(var L=0;L<N.c.length;L++){M.push(N.c[L].b)}var r=D.length-1;do{if(D[r].e){M.push(D[r].e)}r--}while(D[r+1].eW);if(N.i){M.push(N.i)}return f(O,M.join("|"),true)}function p(M,L){var N=D[D.length-1];if(!N.t){N.t=K(N,E)}N.t.lastIndex=L;var r=N.t.exec(M);return r?[M.substr(L,r.index-L),r[0],false]:[M.substr(L),"",true]}function z(N,r){var L=E.cI?r[0].toLowerCase():r[0];var M=N.k[L];if(M&&M instanceof Array){return M}return false}function F(L,P){L=m(L);if(!P.k){return L}var r="";var O=0;P.lR.lastIndex=0;var M=P.lR.exec(L);while(M){r+=L.substr(O,M.index-O);var N=z(P,M);if(N){x+=N[1];r+='<span class="'+N[0]+'">'+M[0]+"</span>"}else{r+=M[0]}O=P.lR.lastIndex;M=P.lR.exec(L)}return r+L.substr(O,L.length-O)}function J(L,M){if(M.sL&&e[M.sL]){var r=d(M.sL,L);x+=r.keyword_count;return r.value}else{return F(L,M)}}function I(M,r){var L=M.cN?'<span class="'+M.cN+'">':"";if(M.rB){y+=L;M.buffer=""}else{if(M.eB){y+=m(r)+L;M.buffer=""}else{y+=L;M.buffer=r}}D.push(M);A+=M.r}function G(N,M,Q){var R=D[D.length-1];if(Q){y+=J(R.buffer+N,R);return false}var P=q(M,R);if(P){y+=J(R.buffer+N,R);I(P,M);return P.rB}var L=v(D.length-1,M);if(L){var O=R.cN?"</span>":"";if(R.rE){y+=J(R.buffer+N,R)+O}else{if(R.eE){y+=J(R.buffer+N,R)+O+m(M)}else{y+=J(R.buffer+N+M,R)+O}}while(L>1){O=D[D.length-2].cN?"</span>":"";y+=O;L--;D.length--}var r=D[D.length-1];D.length--;D[D.length-1].buffer="";if(r.starts){I(r.starts,"")}return R.rE}if(w(M,R)){throw"Illegal"}}var E=e[B];var D=[E.dM];var A=0;var x=0;var y="";try{var s,u=0;E.dM.buffer="";do{s=p(C,u);var t=G(s[0],s[1],s[2]);u+=s[0].length;if(!t){u+=s[1].length}}while(!s[2]);if(D.length>1){throw"Illegal"}return{r:A,keyword_count:x,value:y}}catch(H){if(H=="Illegal"){return{r:0,keyword_count:0,value:m(C)}}else{throw H}}}function g(t){var p={keyword_count:0,r:0,value:m(t)};var r=p;for(var q in e){if(!e.hasOwnProperty(q)){continue}var s=d(q,t);s.language=q;if(s.keyword_count+s.r>r.keyword_count+r.r){r=s}if(s.keyword_count+s.r>p.keyword_count+p.r){r=p;p=s}}if(r.language){p.second_best=r}return p}function i(r,q,p){if(q){r=r.replace(/^((<[^>]+>|\t)+)/gm,function(t,w,v,u){return w.replace(/\t/g,q)})}if(p){r=r.replace(/\n/g,"<br>")}return r}function n(t,w,r){var x=h(t,r);var v=a(t);var y,s;if(v){y=d(v,x)}else{return}var q=c(t);if(q.length){s=document.createElement("pre");s.innerHTML=y.value;y.value=k(q,c(s),x)}y.value=i(y.value,w,r);var u=t.className;if(!u.match("(\\s|^)(language-)?"+v+"(\\s|$)")){u=u?(u+" "+v):v}if(/MSIE [678]/.test(navigator.userAgent)&&t.tagName=="CODE"&&t.parentNode.tagName=="PRE"){s=t.parentNode;var p=document.createElement("div");p.innerHTML="<pre><code>"+y.value+"</code></pre>";t=p.firstChild.firstChild;p.firstChild.cN=s.cN;s.parentNode.replaceChild(p.firstChild,s)}else{t.innerHTML=y.value}t.className=u;t.result={language:v,kw:y.keyword_count,re:y.r};if(y.second_best){t.second_best={language:y.second_best.language,kw:y.second_best.keyword_count,re:y.second_best.r}}}function o(){if(o.called){return}o.called=true;var r=document.getElementsByTagName("pre");for(var p=0;p<r.length;p++){var q=b(r[p]);if(q){n(q,hljs.tabReplace)}}}function l(){if(window.addEventListener){window.addEventListener("DOMContentLoaded",o,false);window.addEventListener("load",o,false)}else{if(window.attachEvent){window.attachEvent("onload",o)}else{window.onload=o}}}var e={};this.LANGUAGES=e;this.highlight=d;this.highlightAuto=g;this.fixMarkup=i;this.highlightBlock=n;this.initHighlighting=o;this.initHighlightingOnLoad=l;this.IR="[a-zA-Z][a-zA-Z0-9_]*";this.UIR="[a-zA-Z_][a-zA-Z0-9_]*";this.NR="\\b\\d+(\\.\\d+)?";this.CNR="\\b(0[xX][a-fA-F0-9]+|(\\d+(\\.\\d*)?|\\.\\d+)([eE][-+]?\\d+)?)";this.BNR="\\b(0b[01]+)";this.RSR="!|!=|!==|%|%=|&|&&|&=|\\*|\\*=|\\+|\\+=|,|\\.|-|-=|/|/=|:|;|<|<<|<<=|<=|=|==|===|>|>=|>>|>>=|>>>|>>>=|\\?|\\[|\\{|\\(|\\^|\\^=|\\||\\|=|\\|\\||~";this.ER="(?![\\s\\S])";this.BE={b:"\\\\.",r:0};this.ASM={cN:"string",b:"'",e:"'",i:"\\n",c:[this.BE],r:0};this.QSM={cN:"string",b:'"',e:'"',i:"\\n",c:[this.BE],r:0};this.CLCM={cN:"comment",b:"//",e:"$"};this.CBLCLM={cN:"comment",b:"/\\*",e:"\\*/"};this.HCM={cN:"comment",b:"#",e:"$"};this.NM={cN:"number",b:this.NR,r:0};this.CNM={cN:"number",b:this.CNR,r:0};this.BNM={cN:"number",b:this.BNR,r:0};this.inherit=function(r,s){var p={};for(var q in r){p[q]=r[q]}if(s){for(var q in s){p[q]=s[q]}}return p}}();hljs.LANGUAGES.cpp=function(){var a={keyword:{"false":1,"int":1,"float":1,"while":1,"private":1,"char":1,"catch":1,"export":1,virtual:1,operator:2,sizeof:2,dynamic_cast:2,typedef:2,const_cast:2,"const":1,struct:1,"for":1,static_cast:2,union:1,namespace:1,unsigned:1,"long":1,"throw":1,"volatile":2,"static":1,"protected":1,bool:1,template:1,mutable:1,"if":1,"public":1,friend:2,"do":1,"return":1,"goto":1,auto:1,"void":2,"enum":1,"else":1,"break":1,"new":1,extern:1,using:1,"true":1,"class":1,asm:1,"case":1,typeid:1,"short":1,reinterpret_cast:2,"default":1,"double":1,register:1,explicit:1,signed:1,typename:1,"try":1,"this":1,"switch":1,"continue":1,wchar_t:1,inline:1,"delete":1,alignof:1,char16_t:1,char32_t:1,constexpr:1,decltype:1,noexcept:1,nullptr:1,static_assert:1,thread_local:1,restrict:1,_Bool:1,complex:1},built_in:{std:1,string:1,cin:1,cout:1,cerr:1,clog:1,stringstream:1,istringstream:1,ostringstream:1,auto_ptr:1,deque:1,list:1,queue:1,stack:1,vector:1,map:1,set:1,bitset:1,multiset:1,multimap:1,unordered_set:1,unordered_map:1,unordered_multiset:1,unordered_multimap:1,array:1,shared_ptr:1}};return{dM:{k:a,i:"</",c:[hljs.CLCM,hljs.CBLCLM,hljs.QSM,{cN:"string",b:"'\\\\?.",e:"'",i:"."},{cN:"number",b:"\\b(\\d+(\\.\\d*)?|\\.\\d+)(u|U|l|L|ul|UL|f|F)"},hljs.CNM,{cN:"preprocessor",b:"#",e:"$"},{cN:"stl_container",b:"\\b(deque|list|queue|stack|vector|map|set|bitset|multiset|multimap|unordered_map|unordered_set|unordered_multiset|unordered_multimap|array)\\s*<",e:">",k:a,r:10,c:["self"]}]}}}();hljs.LANGUAGES.r={dM:{c:[hljs.HCM,{cN:"number",b:"\\b0[xX][0-9a-fA-F]+[Li]?\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"number",b:"\\b\\d+(?:[eE][+\\-]?\\d*)?L\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"number",b:"\\b\\d+\\.(?!\\d)(?:i\\b)?",e:hljs.IMMEDIATE_RE,r:1},{cN:"number",b:"\\b\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d*)?i?\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"number",b:"\\.\\d+(?:[eE][+\\-]?\\d*)?i?\\b",e:hljs.IMMEDIATE_RE,r:1},{cN:"keyword",b:"(?:tryCatch|library|setGeneric|setGroupGeneric)\\b",e:hljs.IMMEDIATE_RE,r:10},{cN:"keyword",b:"\\.\\.\\.",e:hljs.IMMEDIATE_RE,r:10},{cN:"keyword",b:"\\.\\.\\d+(?![\\w.])",e:hljs.IMMEDIATE_RE,r:10},{cN:"keyword",b:"\\b(?:function)",e:hljs.IMMEDIATE_RE,r:2},{cN:"keyword",b:"(?:if|in|break|next|repeat|else|for|return|switch|while|try|stop|warning|require|attach|detach|source|setMethod|setClass)\\b",e:hljs.IMMEDIATE_RE,r:1},{cN:"literal",b:"(?:NA|NA_integer_|NA_real_|NA_character_|NA_complex_)\\b",e:hljs.IMMEDIATE_RE,r:10},{cN:"literal",b:"(?:NULL|TRUE|FALSE|T|F|Inf|NaN)\\b",e:hljs.IMMEDIATE_RE,r:1},{cN:"identifier",b:"[a-zA-Z.][a-zA-Z0-9._]*\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"operator",b:"<\\-(?!\\s*\\d)",e:hljs.IMMEDIATE_RE,r:2},{cN:"operator",b:"\\->|<\\-",e:hljs.IMMEDIATE_RE,r:1},{cN:"operator",b:"%%|~",e:hljs.IMMEDIATE_RE},{cN:"operator",b:">=|<=|==|!=|\\|\\||&&|=|\\+|\\-|\\*|/|\\^|>|<|!|&|\\||\\$|:",e:hljs.IMMEDIATE_RE,r:0},{cN:"operator",b:"%",e:"%",i:"\\n",r:1},{cN:"identifier",b:"`",e:"`",r:0},{cN:"string",b:'"',e:'"',c:[hljs.BE],r:0},{cN:"string",b:"'",e:"'",c:[hljs.BE],r:0},{cN:"paren",b:"[[({\\])}]",e:hljs.IMMEDIATE_RE,r:0}]}};
hljs.initHighlightingOnLoad();
</script>




</head>

<body>
<!-- Automatically generated by RStudio [12861c30b10411e1afa60800200c9a66] -->

<h3>ets_functions.R</h3>

<p>matt &mdash; <em>Feb 21, 2014, 12:21 PM</em></p>

<pre><code class="r"># rm(list=ls())
getwd()
</code></pre>

<pre><code>[1] &quot;D:/Dropbox/Dropbox/HEC/Code/exp1.1/ModelFitting/ets&quot;
</code></pre>

<pre><code class="r">#setwd()
source(&#39;D:/Dropbox/Dropbox/HEC/Code/exp1.1/.Rprofile&#39;)



# functions required:

# FIT: fit an ets model to 445/monthly/weekly data

f_ets.fit = function(y, fit.years = 4)
{
    y.fit = window(y,start=tsp(y)[1], end = tsp(y)[1] + fit.years - 0.0001)
    ets(y.fit)
}


# FORECAST


# ROLL


# SPLIT/AGGREGATE



# EVALUATE
#fit







#==================== TESTING ====================

library(&quot;forecast&quot;) ; library(&quot;xts&quot;) ; library(&quot;data.table&quot;) ; library(&quot;reshape2&quot;)
</code></pre>

<pre><code>Warning: package &#39;forecast&#39; was built under R version 3.0.2
</code></pre>

<pre><code>This is forecast 4.8 

Loading required package: zoo

Attaching package: &#39;zoo&#39;

The following object is masked from &#39;package:base&#39;:

    as.Date, as.Date.numeric


Attaching package: &#39;data.table&#39;

The following object is masked from &#39;package:xts&#39;:

    last
</code></pre>

<pre><code class="r">library(&quot;ggplot2&quot;)

setwd(pth.dropbox.code)
source(&quot;./DataAdaptor/00_data_adaptor_test.R&quot;)
</code></pre>

<pre><code>Warning: Adding new column &#39;hol_Easter_LEAD1&#39; then assigning NULL (deleting it).
Warning: Adding new column &#39;hol_Halloween_LEAD1&#39; then assigning NULL (deleting it).
Warning: Adding new column &#39;hol_Independence_LEAD1&#39; then assigning NULL (deleting it).
Warning: Adding new column &#39;hol_Labor_LEAD1&#39; then assigning NULL (deleting it).
Warning: Adding new column &#39;hol_Memorial_LEAD1&#39; then assigning NULL (deleting it).
Warning: Adding new column &#39;hol_NYE_LEAD1&#39; then assigning NULL (deleting it).
Warning: Adding new column &#39;hol_Presidents_LEAD1&#39; then assigning NULL (deleting it).
Warning: Adding new column &#39;hol_Superbowl_LEAD1&#39; then assigning NULL (deleting it).
Warning: Adding new column &#39;hol_Thanksgiving_LEAD1&#39; then assigning NULL (deleting it).
Warning: Adding new column &#39;hol_Xmas_LEAD1&#39; then assigning NULL (deleting it).
Warning: Adding new column &#39;hol_Easter_LAG1&#39; then assigning NULL (deleting it).
Warning: Adding new column &#39;hol_Halloween_LAG1&#39; then assigning NULL (deleting it).
Warning: Adding new column &#39;hol_Independence_LAG1&#39; then assigning NULL (deleting it).
Warning: Adding new column &#39;hol_Labor_LAG1&#39; then assigning NULL (deleting it).
Warning: Adding new column &#39;hol_Memorial_LAG1&#39; then assigning NULL (deleting it).
Warning: Adding new column &#39;hol_NYE_LAG1&#39; then assigning NULL (deleting it).
Warning: Adding new column &#39;hol_Presidents_LAG1&#39; then assigning NULL (deleting it).
Warning: Adding new column &#39;hol_Superbowl_LAG1&#39; then assigning NULL (deleting it).
Warning: Adding new column &#39;hol_Thanksgiving_LAG1&#39; then assigning NULL (deleting it).
Warning: Adding new column &#39;hol_Xmas_LAG1&#39; then assigning NULL (deleting it).
</code></pre>

<pre><code class="r">

# get the necessary data for a specific item
spw = f_da.reg.cat.test(par.category=&quot;beer&quot;, par.periodicity=&quot;weekly&quot;)
spm = f_da.reg.cat.test(par.category=&quot;beer&quot;, par.periodicity=&quot;445&quot;)

items = spw[!is.na(IRI_KEY),as.character(unique(fc.item))]
items = spm[,as.character(unique(fc.item))]

ssm = spm[fc.item == &quot;00-01-18200-53030&quot;]
ssw = spw[fc.item == &quot;00-01-18200-53030&quot;]



f_diagnotics = function(y)
{
    seasonplot(y,col=rainbow(6))
    plot(stl(y,s.window=&quot;periodic&quot;))
    plot(decompose(y))
    plot(HoltWinters(y))
    #
    fit = f_ets.fit(y, 4)
    plot(fit) ; 
    #fit.acc = accuracy(fit)
    #str(fit.acc)
    #class(fit.acc)
    #fit
    #fit$x

}

# need generic functions to handle time series of varying lengths now...
f_roll.fc.item = function(y, h=6) {

    # rules around length of series (n), horizon (h), splitting rules
    n &lt;- length(y)
    k &lt;- 48             # minimum data length for fitting a model
    err &lt;- matrix(NA, n-k, h) 
    yhat &lt;- matrix(NA, n-k, h)
    act &lt;- matrix(NA, n-k, h)

    m = tsp(y)[3]               # m is seasonal period
    st &lt;- tsp(y)[1]+(k-1)/m     # st = start period in ts terms

    for(i in 1:(n-k-1))
    {
        yhist &lt;- window(y, end= st + (i-1)/m)
        yfuture &lt;- window(y, start= st + i/m , end=st + (i+h-1)/m)
        #warnings()

        print(yhist) 
        print(yfuture)
        # select method
        #fit.tslm &lt;-     tslm(xhist ~ trend + season, lambda=0)
        #fit.Arima &lt;-    Arima(xshort, order=c(3,0,1), seasonal=list(order=c(0,1,1), period=12), 
        #                      include.drift=TRUE, lambda=0, method=&quot;ML&quot;)
        #fit.auto.arima &lt;- auto.arima(xhist)
        #fit &lt;- hw(yhist)$model

        # using ets presently
        fit &lt;- ets(yhist, model=&quot;MMM&quot;, damped=TRUE)  # model=&quot;MMM&quot;,
        print(fit)

        # do the forecasts      
        fcast &lt;- forecast(fit, h=min(n-k-i+1, h))
        print(fcast)

        # record the data
        err[i,1:length(yfuture)] &lt;- fcast[[&#39;mean&#39;]]-yfuture
        act[i,1:length(yfuture)] &lt;- yfuture
        yhat[i,1:length(yfuture)] &lt;- fcast[[&#39;mean&#39;]]
    }

    # prepare the accuracy stats
    act.melt = data.table(melt(act,value.name=&quot;y&quot;, varnames=c(&quot;t&quot;,&quot;k&quot;)),key=&quot;t,k&quot;) [!is.na(y)]
    yhat.melt = data.table(melt(yhat,value.name=&quot;yhat&quot;, varnames=c(&quot;t&quot;,&quot;k&quot;)),key=&quot;t,k&quot;) [!is.na(yhat)]
    Err = act.melt[yhat.melt]
    Err[,`:=` (e = yhat - y, ae = abs(yhat-y), 
               re = (yhat - y)/y, rae = abs((yhat - y)/y))]
    tables()

    list(Err = Err, fit = fit)
}

f_plot.ts.fit = function(fit)
{
    require(ggplot2)

    # prepare data.table of insample errors &amp; fitted values
    dt = data.table(y = as.numeric(fit$x), y.fit = as.numeric(fit$fitted))
    dt[,`:=`(E=y-y.fit, AE=abs(y-y.fit))]
    dt[,CE:=cumsum(E)]

    # make a plot with 
    p = ggplot(data = dt) + 

        # error blocks (residuals)
        geom_bar(aes(x=factor(1:71), y = E, geom = &quot;bar&quot;, fill = &quot;orange&quot;), stat=&quot;identity&quot;) +

        # the actuals
        geom_line(aes(x=1:71, y = y), colour = &quot;darkgreen&quot;) +
        geom_point(aes(x=1:71, y = y), colour = &quot;darkgreen&quot;) +

        # fitted values
        geom_line(aes(x=1:71, y = y.fit), colour = &quot;indianred2&quot;) +
        geom_point(aes(x=1:71, y = y.fit), colour = &quot;indianred2&quot;) +

        # tracking signal
        #geom_point(aes(x=1:71, y = CE), alpha = 0.2) +
        #geom_line(aes(x=1:71, y = CE), alpha = 0.2) +

        # presentation
        theme_bw() + theme(legend.position = &quot;none&quot;) +
        theme(panel.grid.minor.x=element_blank(), panel.grid.major.x=element_blank()) +
        theme(axis.text.x  = element_text(angle=-90, vjust=0.5, size=10)) +
        ggtitle(&quot;Item-level plot for SKU\n&quot;) + xlab(&quot;\nTime Period (445 Periods)&quot;)

    #barplot(as.numeric(fit$x-fit$fitted), ylim = c(-3000,18000),col = &quot;lightblue&quot;)
    #lines(as.numeric(fit$fitted), col = 4, type = &quot;o&quot;) ; lines(as.numeric(fit$x), col = 2, type = &quot;o&quot;)
    #hline(y=0)
    p
}



#a way to get separate plots for each plot
plot2 &lt;- function(theplot, name, ...) {
    name &lt;- paste0(name, &quot;.png&quot;)
    png(filename=name,width=800,height=500)
    print(theplot)
    dev.off()
} #plotting function


f_run.item = function(ssm, h, fc.item = &quot;00-01-18200-53030&quot;, pth = NULL)
{


    y = ts(ssm$UNITS, start=c(2001,1), frequency = 12)
    roll = f_roll.fc.item(y, h = h)

    #p = f_plot.ts.fit(roll$fit) 
    #plot2(theplot=p, name=paste0(&quot;D:/TEMP/IRI_PLOTS/&quot;,i))
    #ggsave(filename=fil, plot=p, width=8, height=8, units=&quot;cm&quot;)
    #list(roll,p)
    roll
}


# testing

item.id=2
ssm = spm[fc.item == items[item.id]]
this.roll = f_run.item(ssm, h=3)
</code></pre>

<pre><code>      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
      Jan  Feb  Mar
2005 3399 2948 3771
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.0145 
    beta  = 0.0107 
    gamma = 0.0327 
    phi   = 0.9611 

  Initial states:
    l = 3507.9662 
    b = 1.0229 
    s=1.356 0.8388 0.8519 1.356 0.8302 1.143
           1.488 1.147 0.753 0.7962 0.6972 0.7431

  sigma:  0.1533

  AIC  AICc   BIC 
842.7 863.1 874.5 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
Jan 2005           3416  2740  4083  2388  4482
Feb 2005           3194  2556  3830  2219  4164
Mar 2005           3634  2925  4368  2540  4736
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399                                                       
      Feb  Mar  Apr
2005 2948 3771 2884
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.0103 
    beta  = 0.0103 
    gamma = 0.0128 
    phi   = 0.9534 

  Initial states:
    l = 3513.3994 
    b = 1.0244 
    s=1.274 0.867 0.8443 1.351 0.9592 1.253
           1.382 1.043 0.7551 0.7935 0.7101 0.7666

  sigma:  0.1452

  AIC  AICc   BIC 
854.8 874.6 887.0 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
Feb 2005           3214  2617  3801  2298  4118
Mar 2005           3582  2905  4223  2571  4585
Apr 2005           3399  2763  4034  2440  4390
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399 2948                                                  
      Mar  Apr  May
2005 3771 2884 3505
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 1e-04 
    beta  = 1e-04 
    gamma = 0.0377 
    phi   = 0.9283 

  Initial states:
    l = 3515.4911 
    b = 1.0215 
    s=1.303 0.8589 0.8311 1.46 0.8639 1.234
           1.388 1.034 0.8132 0.7525 0.7024 0.7591

  sigma:  0.1476

  AIC  AICc   BIC 
871.0 890.1 903.5 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
Mar 2005           3503  2834  4150  2474  4502
Apr 2005           3726  3019  4440  2633  4836
May 2005           4781  3888  5693  3385  6178
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399 2948 3771                                             
      Apr  May  Jun
2005 2884 3505 5402
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.2544 
    beta  = 2e-04 
    gamma = 1e-04 
    phi   = 0.9742 

  Initial states:
    l = 3521.3684 
    b = 1.0147 
    s=1.296 0.8555 0.8308 1.379 0.9373 1.182
           1.395 1.066 0.801 0.8053 0.6882 0.7648

  sigma:  0.1509

  AIC  AICc   BIC 
891.5 910.1 924.4 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
Apr 2005           3575  2887  4281  2483  4621
May 2005           4774  3830  5758  3334  6274
Jun 2005           6269  4981  7543  4357  8246
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399 2948 3771 2884                                        
      May  Jun  Jul
2005 3505 5402 4862
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.0112 
    beta  = 0.0112 
    gamma = 3e-04 
    phi   = 0.9505 

  Initial states:
    l = 3518.4457 
    b = 1.0256 
    s=1.353 0.8392 0.8422 1.356 0.9037 1.219
           1.381 1.088 0.7656 0.8115 0.6667 0.7742

  sigma:  0.1421

  AIC  AICc   BIC 
904.3 922.3 937.4 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
May 2005           4865  3965  5737  3478  6222
Jun 2005           6143  5023  7280  4380  7874
Jul 2005           5400  4425  6391  3864  6918
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399 2948 3771 2884 3505                                   
      Jun  Jul  Aug
2005 5402 4862 3974
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.015 
    beta  = 0.0143 
    gamma = 1e-04 
    phi   = 0.9711 

  Initial states:
    l = 3508.4622 
    b = 1.0249 
    s=1.286 0.8632 0.8639 1.4 0.9157 1.204
           1.396 1.042 0.7426 0.8458 0.6861 0.7539

  sigma:  0.1452

  AIC  AICc   BIC 
924.7 942.2 958.2 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
Jun 2005           6012  4893  7152  4277  7749
Jul 2005           5142  4195  6100  3708  6598
Aug 2005           3876  3148  4617  2768  5018
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399 2948 3771 2884 3505 5402                              
      Jul  Aug  Sep
2005 4862 3974 5484
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.1251 
    beta  = 0.006 
    gamma = 1e-04 
    phi   = 0.9376 

  Initial states:
    l = 3480.4672 
    b = 1.0262 
    s=1.308 0.8596 0.8738 1.416 0.9051 1.194
           1.378 1.015 0.7502 0.827 0.7025 0.7719

  sigma:  0.1463

  AIC  AICc   BIC 
942.5 959.5 976.3 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
Jul 2005           4966  4056  5862  3575  6353
Aug 2005           3755  3054  4489  2692  4877
Sep 2005           5857  4768  6977  4195  7604
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399 2948 3771 2884 3505 5402 4862                         
      Aug  Sep  Oct
2005 3974 5484 3644
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.0136 
    beta  = 0.0135 
    gamma = 0.0027 
    phi   = 0.9521 

  Initial states:
    l = 3471.868 
    b = 1.0289 
    s=1.383 0.8839 0.8165 1.397 0.9243 1.223
           1.3 1.044 0.741 0.8416 0.6877 0.7582

  sigma:  0.1434

  AIC  AICc   BIC 
959.8 976.4 994.0 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
Aug 2005           3959  3211  4691  2809  5046
Sep 2005           5930  4807  6993  4247  7578
Oct 2005           3440  2814  4087  2493  4420
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399 2948 3771 2884 3505 5402 4862 3974                    
      Sep  Oct  Nov
2005 5484 3644 3263
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.0124 
    beta  = 0.012 
    gamma = 1e-04 
    phi   = 0.9345 

  Initial states:
    l = 3474.2652 
    b = 1.0302 
    s=1.322 0.8724 0.8285 1.431 0.8979 1.164
           1.449 1.058 0.7172 0.8124 0.7011 0.7464

  sigma:  0.1446

   AIC   AICc    BIC 
 978.1  994.2 1012.6 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
Sep 2005           6206  5056  7388  4419  7965
Oct 2005           3566  2914  4240  2587  4635
Nov 2005           3728  3039  4416  2689  4828
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399 2948 3771 2884 3505 5402 4862 3974 5484               
      Oct  Nov  Dec
2005 3644 3263 5542
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.0142 
    beta  = 0.0138 
    gamma = 0.0072 
    phi   = 0.9569 

  Initial states:
    l = 3464.6817 
    b = 1.0278 
    s=1.348 0.843 0.8598 1.391 0.9183 1.2
           1.343 1.033 0.7347 0.8504 0.7261 0.752

  sigma:  0.1413

   AIC   AICc    BIC 
 994.4 1010.1 1029.1 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
Oct 2005           3589  2933  4235  2597  4565
Nov 2005           3493  2860  4148  2504  4481
Dec 2005           5526  4541  6499  3995  7057
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399 2948 3771 2884 3505 5402 4862 3974 5484 3644          
      Jan Feb Mar Apr May Jun Jul Aug Sep Oct  Nov  Dec
2005                                          3263 5542
2006 3582                                              
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.0143 
    beta  = 0.014 
    gamma = 9e-04 
    phi   = 0.9717 

  Initial states:
    l = 3469.3448 
    b = 1.0253 
    s=1.308 0.8627 0.8527 1.407 0.8993 1.17
           1.321 1.086 0.7668 0.8308 0.7187 0.7773

  sigma:  0.1399

 AIC AICc  BIC 
1011 1026 1046 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
Nov 2005           3519  2888  4138  2533  4469
Dec 2005           5290  4348  6252  3837  6774
Jan 2006           3117  2544  3671  2240  3973
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399 2948 3771 2884 3505 5402 4862 3974 5484 3644 3263     
      Jan  Feb Mar Apr May Jun Jul Aug Sep Oct Nov  Dec
2005                                               5542
2006 3582 2024                                         
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.0147 
    beta  = 0.0146 
    gamma = 3e-04 
    phi   = 0.9681 

  Initial states:
    l = 3473.5185 
    b = 1.0253 
    s=1.323 0.8688 0.8333 1.464 0.8862 1.188
           1.372 1.042 0.7544 0.8302 0.6942 0.745

  sigma:  0.1404

 AIC AICc  BIC 
1029 1043 1064 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
Dec 2005           5378  4401  6345  3858  6910
Jan 2006           2999  2462  3553  2172  3830
Feb 2006           2767  2281  3272  2034  3526
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399 2948 3771 2884 3505 5402 4862 3974 5484 3644 3263 5542
      Jan  Feb  Mar
2006 3582 2024 2917
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.32 
    beta  = 1e-04 
    gamma = 0.0016 
    phi   = 0.98 

  Initial states:
    l = 3473.4306 
    b = 1.0122 
    s=1.345 0.9114 0.866 1.329 0.9193 1.198
           1.281 1.047 0.7573 0.84 0.7324 0.7734

  sigma:  0.1478

 AIC AICc  BIC 
1051 1065 1086 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
Jan 2006           3140  2561  3722  2249  4016
Feb 2006           2983  2378  3576  2088  3901
Mar 2006           3434  2722  4166  2365  4558
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399 2948 3771 2884 3505 5402 4862 3974 5484 3644 3263 5542
2006 3582                                                       
      Feb  Mar  Apr
2006 2024 2917 2483
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.013 
    beta  = 0.0127 
    gamma = 1e-04 
    phi   = 0.9428 

  Initial states:
    l = 3472.9959 
    b = 1.0298 
    s=1.32 0.8621 0.8419 1.368 0.9049 1.214
           1.348 1.051 0.771 0.8282 0.6931 0.7976

  sigma:  0.1359

 AIC AICc  BIC 
1060 1075 1096 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
Feb 2006           2846  2352  3353  2091  3596
Mar 2006           3380  2808  3976  2490  4287
Apr 2006           3128  2588  3661  2287  3949
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399 2948 3771 2884 3505 5402 4862 3974 5484 3644 3263 5542
2006 3582 2024                                                  
      Mar  Apr  May
2006 2917 2483 2600
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.015 
    beta  = 0.0144 
    gamma = 1e-04 
    phi   = 0.9724 

  Initial states:
    l = 3473.7343 
    b = 1.0243 
    s=1.377 0.8711 0.8421 1.345 0.9678 1.22
           1.323 1.02 0.7749 0.829 0.6579 0.7713

  sigma:  0.1421

 AIC AICc  BIC 
1083 1097 1119 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
Mar 2006           3255  2684  3875  2339  4156
Apr 2006           3013  2467  3555  2164  3838
May 2006           3929  3217  4662  2829  5038
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399 2948 3771 2884 3505 5402 4862 3974 5484 3644 3263 5542
2006 3582 2024 2917                                             
      Apr  May  Jun
2006 2483 2600 4410
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.0149 
    beta  = 0.0145 
    gamma = 2e-04 
    phi   = 0.9782 

  Initial states:
    l = 3474.4077 
    b = 1.0233 
    s=1.323 0.8692 0.8577 1.374 0.9312 1.228
           1.343 1.034 0.7664 0.8261 0.6646 0.7834

  sigma:  0.1401

 AIC AICc  BIC 
1098 1112 1135 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
Apr 2006           2952  2416  3484  2121  3773
May 2006           3940  3230  4636  2868  5010
Jun 2006           5064  4153  5982  3677  6474
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399 2948 3771 2884 3505 5402 4862 3974 5484 3644 3263 5542
2006 3582 2024 2917 2483                                        
      May  Jun  Jul
2006 2600 4410 3842
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.1359 
    beta  = 0.0171 
    gamma = 1e-04 
    phi   = 0.9695 

  Initial states:
    l = 3477.3802 
    b = 1.029 
    s=1.392 0.8512 0.8355 1.371 0.9209 1.227
           1.34 1.043 0.7324 0.8192 0.6717 0.7962

  sigma:  0.1428

 AIC AICc  BIC 
1117 1130 1153 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
May 2006           3840  3126  4535  2780  4905
Jun 2006           4883  3989  5788  3545  6279
Jul 2006           4428  3577  5239  3140  5700
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399 2948 3771 2884 3505 5402 4862 3974 5484 3644 3263 5542
2006 3582 2024 2917 2483 2600                                   
      Jun  Jul  Aug
2006 4410 3842 2585
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.1075 
    beta  = 0.0184 
    gamma = 1e-04 
    phi   = 0.98 

  Initial states:
    l = 3475.2733 
    b = 1.0259 
    s=1.335 0.8842 0.8818 1.359 0.9278 1.207
           1.327 1.005 0.759 0.8486 0.6806 0.7849

  sigma:  0.1461

 AIC AICc  BIC 
1138 1151 1175 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
Jun 2006           4597  3730  5448  3275  5903
Jul 2006           4107  3322  4880  2866  5281
Aug 2006           3103  2513  3705  2207  4007
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399 2948 3771 2884 3505 5402 4862 3974 5484 3644 3263 5542
2006 3582 2024 2917 2483 2600 4410                              
      Jul  Aug  Sep
2006 3842 2585 4252
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.1553 
    beta  = 0.018 
    gamma = 1e-04 
    phi   = 0.9674 

  Initial states:
    l = 3488.9663 
    b = 1.0294 
    s=1.332 0.8618 0.8414 1.372 0.9215 1.256
           1.342 1.006 0.746 0.8119 0.6899 0.819

  sigma:  0.1452

 AIC AICc  BIC 
1155 1167 1192 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
Jul 2006           4218  3399  5016  2984  5405
Aug 2006           3048  2480  3620  2153  3924
Sep 2006           4473  3615  5333  3152  5805
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399 2948 3771 2884 3505 5402 4862 3974 5484 3644 3263 5542
2006 3582 2024 2917 2483 2600 4410 3842                         
      Aug  Sep  Oct
2006 2585 4252 3102
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.1474 
    beta  = 0.0207 
    gamma = 0.0018 
    phi   = 0.9799 

  Initial states:
    l = 3467.3988 
    b = 1.0276 
    s=1.359 0.9058 0.8483 1.356 0.9157 1.196
           1.324 0.9816 0.76 0.8606 0.6909 0.8031

  sigma:  0.145

 AIC AICc  BIC 
1172 1185 1210 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
Aug 2006           2965  2428  3520  2134  3815
Sep 2006           4311  3490  5107  3060  5545
Oct 2006           2649  2128  3162  1876  3453
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399 2948 3771 2884 3505 5402 4862 3974 5484 3644 3263 5542
2006 3582 2024 2917 2483 2600 4410 3842 2585                    
      Sep  Oct  Nov
2006 4252 3102 3457
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.2946 
    beta  = 0.0177 
    gamma = 0.0051 
    phi   = 0.9687 

  Initial states:
    l = 3485.8311 
    b = 1.0323 
    s=1.347 0.856 0.8414 1.407 0.8928 1.218
           1.366 0.9943 0.752 0.8168 0.6771 0.8306

  sigma:  0.1472

 AIC AICc  BIC 
1191 1203 1229 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
Sep 2006           4262  3475  5073  3039  5491
Oct 2006           2520  2014  3024  1750  3306
Nov 2006           2532  2013  3082  1748  3377
      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399 2948 3771 2884 3505 5402 4862 3974 5484 3644 3263 5542
2006 3582 2024 2917 2483 2600 4410 3842 2585 4252               
      Oct  Nov  Dec
2006 3102 3457 5730
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.179 
    beta  = 0.0226 
    gamma = 1e-04 
    phi   = 0.9663 

  Initial states:
    l = 3486.0418 
    b = 1.0329 
    s=1.353 0.8584 0.8605 1.365 0.918 1.207
           1.355 0.9991 0.7503 0.8259 0.6928 0.8155

  sigma:  0.1429

 AIC AICc  BIC 
1205 1217 1243 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
Oct 2006           2608  2124  3078  1869  3344
Nov 2006           2554  2094  3025  1860  3293
Dec 2006           3954  3200  4743  2803  5158
</code></pre>

<pre><code>Warning: &#39;end&#39; value not changed
</code></pre>

<pre><code>      Jan  Feb  Mar  Apr  May  Jun  Jul  Aug  Sep  Oct  Nov  Dec
2001 2651 2155 2657 3138 3723 5485 3448 3572 5947 3969 4154 5784
2002 2139 3574 3120 3427 5925 6936 5637 3171 5645 3041 3594 6891
2003 4297 2773 3499 3044 4401 5011 6113 3917 5648 4065 4196 5384
2004 3533 3449 4521 3732 4136 5792 5893 4847 6500 3438 3399 4806
2005 3399 2948 3771 2884 3505 5402 4862 3974 5484 3644 3263 5542
2006 3582 2024 2917 2483 2600 4410 3842 2585 4252 3102          
      Nov  Dec
2006 3457 5730
ETS(M,Md,M) 

Call:
 ets(y = yhist, model = &quot;MMM&quot;, damped = TRUE) 

  Smoothing parameters:
    alpha = 0.1951 
    beta  = 0.0247 
    gamma = 1e-04 
    phi   = 0.98 

  Initial states:
    l = 3488.1428 
    b = 1.0343 
    s=1.461 0.8807 0.8847 1.31 0.8927 1.192
           1.291 1.019 0.7384 0.8557 0.6957 0.7796

  sigma:  0.1479

 AIC AICc  BIC 
1227 1239 1266 
         Point Forecast Lo 80 Hi 80 Lo 95 Hi 95
Nov 2006           2725  2199  3250  1935  3511
Dec 2006           4456  3612  5321  3148  5794
     NAME      NROW MB COLS                   KEY
[1,] act.melt    68 1  t,k,y                  t,k
[2,] Err         68 1  t,k,y,yhat,e,ae,re,rae t,k
[3,] yhat.melt   68 1  t,k,yhat               t,k
Total: 3MB
</code></pre>

<pre><code class="r">Err = this.roll$Err


#lapply(1:length(items),function(i) f_run.item(spm,i, items))

f_summary.plots = function(Err) {

    ggplot(data=Err, aes(y=re, x = factor(k))) +geom_boxplot()
    ggplot(data=Err, aes(x=e, colour = factor(k))) + geom_density()+        theme_bw()

    ggplot(data=Err, aes(x=e)) + geom_histogram() +         facet_wrap(~k)

    Err[,list(n=length(y), me = mean(e), mae = mean(ae), mrae = mean(re)),by=list(k)]
}

f_summary.plots(Err)
</code></pre>

<pre><code>   k  n    me   mae    mrae
1: 1 23 246.8 435.6 0.08393
2: 2 23 196.7 551.6 0.07863
3: 3 22 235.2 605.5 0.08728
</code></pre>

<pre><code class="r">Err
</code></pre>

<pre><code>     t k    y yhat        e      ae        re      rae
 1:  1 1 3399 3416    16.59   16.59  0.004881 0.004881
 2:  1 2 2948 3194   245.54  245.54  0.083290 0.083290
 3:  1 3 3771 3634  -136.54  136.54 -0.036207 0.036207
 4:  2 1 2948 3214   266.11  266.11  0.090269 0.090269
 5:  2 2 3771 3582  -189.30  189.30 -0.050200 0.050200
 6:  2 3 2884 3399   515.06  515.06  0.178593 0.178593
 7:  3 1 3771 3503  -267.75  267.75 -0.071002 0.071002
 8:  3 2 2884 3726   841.68  841.68  0.291845 0.291845
 9:  3 3 3505 4781  1275.90 1275.90  0.364023 0.364023
10:  4 1 2884 3575   690.55  690.55  0.239442 0.239442
11:  4 2 3505 4774  1268.59 1268.59  0.361937 0.361937
12:  4 3 5402 6269   866.98  866.98  0.160493 0.160493
13:  5 1 3505 4865  1360.04 1360.04  0.388030 0.388030
14:  5 2 5402 6143   741.11  741.11  0.137191 0.137191
15:  5 3 4862 5400   537.93  537.93  0.110640 0.110640
16:  6 1 5402 6012   609.62  609.62  0.112850 0.112850
17:  6 2 4862 5142   279.63  279.63  0.057514 0.057514
18:  6 3 3974 3876   -97.53   97.53 -0.024542 0.024542
19:  7 1 4862 4966   103.93  103.93  0.021376 0.021376
20:  7 2 3974 3755  -219.27  219.27 -0.055175 0.055175
21:  7 3 5484 5857   373.05  373.05  0.068024 0.068024
22:  8 1 3974 3959   -15.20   15.20 -0.003826 0.003826
23:  8 2 5484 5930   446.28  446.28  0.081379 0.081379
24:  8 3 3644 3440  -204.19  204.19 -0.056034 0.056034
25:  9 1 5484 6206   722.34  722.34  0.131717 0.131717
26:  9 2 3644 3566   -78.33   78.33 -0.021496 0.021496
27:  9 3 3263 3728   464.89  464.89  0.142474 0.142474
28: 10 1 3644 3589   -55.07   55.07 -0.015114 0.015114
29: 10 2 3263 3493   230.40  230.40  0.070610 0.070610
30: 10 3 5542 5526   -15.86   15.86 -0.002862 0.002862
31: 11 1 3263 3519   256.06  256.06  0.078473 0.078473
32: 11 2 5542 5290  -251.77  251.77 -0.045429 0.045429
33: 11 3 3582 3117  -464.87  464.87 -0.129779 0.129779
34: 12 1 5542 5378  -164.16  164.16 -0.029620 0.029620
35: 12 2 3582 2999  -583.26  583.26 -0.162831 0.162831
36: 12 3 2024 2767   743.45  743.45  0.367317 0.367317
37: 13 1 3582 3140  -442.26  442.26 -0.123467 0.123467
38: 13 2 2024 2983   959.39  959.39  0.474005 0.474005
39: 13 3 2917 3434   517.03  517.03  0.177247 0.177247
40: 14 1 2024 2846   822.06  822.06  0.406156 0.406156
41: 14 2 2917 3380   462.98  462.98  0.158719 0.158719
42: 14 3 2483 3128   644.82  644.82  0.259693 0.259693
43: 15 1 2917 3255   338.36  338.36  0.115995 0.115995
44: 15 2 2483 3013   530.20  530.20  0.213532 0.213532
45: 15 3 2600 3929  1329.09 1329.09  0.511189 0.511189
46: 16 1 2483 2952   469.14  469.14  0.188942 0.188942
47: 16 2 2600 3940  1340.30 1340.30  0.515499 0.515499
48: 16 3 4410 5064   654.00  654.00  0.148299 0.148299
49: 17 1 2600 3840  1239.76 1239.76  0.476831 0.476831
50: 17 2 4410 4883   473.16  473.16  0.107293 0.107293
51: 17 3 3842 4428   585.96  585.96  0.152514 0.152514
52: 18 1 4410 4597   187.11  187.11  0.042429 0.042429
53: 18 2 3842 4107   264.84  264.84  0.068932 0.068932
54: 18 3 2585 3103   518.03  518.03  0.200397 0.200397
55: 19 1 3842 4218   375.81  375.81  0.097816 0.097816
56: 19 2 2585 3048   462.94  462.94  0.179087 0.179087
57: 19 3 4252 4473   221.29  221.29  0.052044 0.052044
58: 20 1 2585 2965   379.78  379.78  0.146916 0.146916
59: 20 2 4252 4311    58.79   58.79  0.013826 0.013826
60: 20 3 3102 2649  -452.67  452.67 -0.145927 0.145927
61: 21 1 4252 4262    10.00   10.00  0.002353 0.002353
62: 21 2 3102 2520  -582.31  582.31 -0.187720 0.187720
63: 21 3 3457 2532  -924.89  924.89 -0.267540 0.267540
64: 22 1 3102 2608  -494.02  494.02 -0.159260 0.159260
65: 22 2 3457 2554  -902.59  902.59 -0.261090 0.261090
66: 22 3 5730 3954 -1776.29 1776.29 -0.309999 0.309999
67: 23 1 3457 2725  -732.32  732.32 -0.211836 0.211836
68: 23 2 5730 4456 -1273.91 1273.91 -0.222323 0.222323
     t k    y yhat        e      ae        re      rae
</code></pre>

<pre><code class="r">
</code></pre>

</body>

</html>

